# 关键内存泄漏修复

根据崩溃日志分析，这是 Hermes 内存溢出（OOM）问题。以下是已实施的关键修复：

## 🔴 最关键的修复

### 1. 修复无限循环（已修复）
- **位置**：`app/app/chat/[id].tsx` 第478行的 `useEffect`
- **问题**：依赖项包含 `messages`，而 effect 内部会更新 `messages`
- **修复**：从依赖项中移除 `messages`

### 2. 限制消息数组大小（已修复）
- **位置**：`app/services/chatService.ts` 和 `app/app/chat/[id].tsx`
- **问题**：消息数组可以无限增长，导致内存溢出
- **修复**：
  - 存储中最多保留50条消息
  - 内存中最多保留50条消息
  - 所有状态更新都会检查并限制数组大小

### 3. 减少日志输出（已修复）
- **位置**：`app/services/qianwenService.ts`
- **问题**：大量 `console.log` 会消耗内存
- **修复**：只在开发模式（`__DEV__`）下输出详细日志

## 📋 检查清单

根据你的分析，以下是需要检查的常见内存泄漏模式：

### ✅ 已检查并修复
- [x] 定时器清理（所有 `setTimeout` 都有清理函数）
- [x] 消息数组限制（最多50条）
- [x] 日志输出限制（只在开发模式）
- [x] useEffect 依赖项（修复了无限循环）

### ⚠️ 需要进一步检查
- [ ] 是否有未清理的事件监听器？
- [ ] 是否有 base64 图片存储在状态中？
- [ ] 是否有其他大数组/对象无限增长？

## 🧪 测试步骤

1. **完全重置环境**：
   ```bash
   # 关闭所有应用
   # 重置模拟器
   xcrun simctl shutdown all
   xcrun simctl erase all
   
   # 清除缓存
   cd app
   npx expo start -c
   ```

2. **测试最小场景**：
   - 打开应用
   - 发送一条简短消息（如"你好"）
   - 等待AI回复
   - 观察是否崩溃

3. **如果仍然崩溃**：
   - 检查 Metro 终端输出
   - 使用 Chrome DevTools 监控内存
   - 尝试构建开发客户端（使用 JSC）

## 🔍 如果问题仍然存在

根据你的分析，如果问题仍然存在，可能是：

1. **模拟器内存压力**：
   - 关闭其他应用
   - 关闭其他模拟器
   - 关闭 Chrome 标签页
   - 尝试在真机上测试

2. **Hermes 特定问题**：
   - 构建开发客户端，使用 JSC：
     ```bash
     cd app
     npx expo prebuild
     npx expo run:ios
     ```

3. **其他内存泄漏**：
   - 使用 Instruments 分析内存增长
   - 检查是否有其他组件也在泄漏内存

## 📊 当前限制

- 消息数组：最多50条（内存和存储）
- API响应：最多300字符
- 用户消息：最多200字符
- 系统提示词：最多200字符
- max_tokens：300

这些限制已经非常严格，如果仍然崩溃，可能需要考虑：
- 使用原生模块处理 API 调用
- 或者暂时禁用 AI 功能，直到找到更好的解决方案



